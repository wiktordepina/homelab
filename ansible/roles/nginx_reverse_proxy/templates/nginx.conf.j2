user    root    root;
worker_processes    auto;
error_log   /var/log/nginx/error.log    warn;
pid /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {

    server {
        listen  80  default_server;
        listen  [::]:80;
        server_name _;

        return 301 https://$host$request_uri;
    }

    {% for server_name_prefix, proxy_url in nginx_reverse_proxy_servers.items() -%}
    server {
        listen  443 ssl;
        listen  [::]:443    ssl;
        server_name {{server_name_prefix}}.homelab.matagoth.com;

        ssl_certificate /etc/letsencrypt/live/matagoth.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/matagoth.com/privkey.pem;
        ssl_protocols TLSv1.1   TLSv1.2   TLSv1.3;

        location / {
            proxy_pass  {{proxy_url}};

            proxy_ssl_verify off;

            proxy_set_header    Host   $host;
            proxy_set_header    X-Real-IP   $remote_addr;
            proxy_set_header    X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header    Upgrade $http_upgrade;
            proxy_set_header    Connection 'upgrade';
            proxy_cache_bypass  $http_upgrade;
        }
    }
    {%- endfor %}
}
